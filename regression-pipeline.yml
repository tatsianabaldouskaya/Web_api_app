schedules:
  - cron: "0 8 * * *"
    displayName: "Daily Schedule"
    branches:
      include:
        - main
    always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
 UI_PORT: '44388'
 API_PORT: '7203'

steps:
  - task: UseDotNet@2
    displayName: 'Install SDK'
    inputs:
      version: '8.x'

  - checkout: self

  - task: DotNetCoreCLI@2
    displayName: 'Build the Project'
    inputs:
      command: 'build'
      projects: '**/*.csproj'

- task: DotNetCoreCLI@2
    displayName: 'Publish the Application'
    inputs:
      command: 'publish'
      projects: '**/*.sln'
      arguments: '--configuration Release --output $(System.DefaultWorkingDirectory)/PublishedApp'

  - script: |
      echo "Starting the API application..."
      cd $(System.DefaultWorkingDirectory)/PublishedApp
      start /B dotnet $(System.DefaultWorkingDirectory)/PublishedApp/WebApplicationApi/WebApplicationApi.dll --urls=http://localhost:$(API_PORT)
    displayName: 'Start the API Application'

  # Step 8: Start the UI Application in the Background
  - script: |
      echo "Starting the UI application..."
      cd $(System.DefaultWorkingDirectory)/PublishedApp
      start /B dotnet $(System.DefaultWorkingDirectory)/PublishedApp/WebAppUI/WebAppUI.dll --urls=http://localhost:$(UI_PORT)
    displayName: 'Start the UI Application'

  - script: |
      echo "Running UI tests..."
      cd $(System.DefaultWorkingDirectory)/Tests # Example assuming UI tests are located in this path
      dotnet test --filter FullyQualifiedName~EndToEndTests
    displayName: 'Run UI Tests'